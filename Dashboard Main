<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>NHL Quick Reference</title>
<link href="https://fonts.googleapis.com/css2?family=Oswald:wght@400;500;600;700&family=Source+Code+Pro:wght@400;500;600&family=Barlow+Condensed:wght@400;500;600;700&display=swap" rel="stylesheet">
<style>
  :root {
    --bg-deep: #0a0c10;
    --bg-card: #12151c;
    --bg-card-hover: #181c26;
    --border: #1e2333;
    --border-bright: #2a3050;
    --text-primary: #e8eaf0;
    --text-secondary: #7a82a0;
    --text-muted: #4a5070;
    --accent-ice: #4fc3f7;
    --accent-red: #ef5350;
    --accent-green: #66bb6a;
    --accent-gold: #ffd54f;
    --accent-orange: #ff9800;
    --glow-ice: rgba(79, 195, 247, 0.15);
    --glow-red: rgba(239, 83, 80, 0.15);
  }

  * { margin: 0; padding: 0; box-sizing: border-box; }

  body {
    background: var(--bg-deep);
    color: var(--text-primary);
    font-family: 'Barlow Condensed', sans-serif;
    min-height: 100vh;
    overflow-x: hidden;
  }

  /* Subtle ice rink texture */
  body::before {
    content: '';
    position: fixed;
    inset: 0;
    background:
      radial-gradient(ellipse 80% 50% at 50% 0%, rgba(79,195,247,0.03) 0%, transparent 60%),
      radial-gradient(ellipse 60% 40% at 80% 100%, rgba(239,83,80,0.02) 0%, transparent 50%);
    pointer-events: none;
    z-index: 0;
  }

  .app { position: relative; z-index: 1; max-width: 1400px; margin: 0 auto; padding: 20px 24px 60px; }

  /* Header */
  .header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 20px 0 28px;
    border-bottom: 1px solid var(--border);
    margin-bottom: 28px;
  }
  .header-left { display: flex; align-items: baseline; gap: 16px; }
  .logo {
    font-family: 'Oswald', sans-serif;
    font-weight: 700;
    font-size: 1.8rem;
    letter-spacing: 2px;
    text-transform: uppercase;
    color: var(--text-primary);
  }
  .logo span { color: var(--accent-ice); }
  .header-tag {
    font-family: 'Source Code Pro', monospace;
    font-size: 0.72rem;
    color: var(--text-muted);
    letter-spacing: 1px;
    text-transform: uppercase;
    border: 1px solid var(--border);
    padding: 3px 10px;
    border-radius: 3px;
  }
  .header-right { display: flex; align-items: center; gap: 14px; }
  .status-dot {
    width: 7px; height: 7px;
    background: var(--accent-green);
    border-radius: 50%;
    box-shadow: 0 0 6px var(--accent-green);
    animation: pulse-dot 2s ease-in-out infinite;
  }
  @keyframes pulse-dot {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.4; }
  }
  .status-text {
    font-family: 'Source Code Pro', monospace;
    font-size: 0.72rem;
    color: var(--text-secondary);
    letter-spacing: 0.5px;
  }
  .refresh-btn {
    background: transparent;
    border: 1px solid var(--border);
    color: var(--text-secondary);
    font-family: 'Source Code Pro', monospace;
    font-size: 0.72rem;
    padding: 5px 14px;
    border-radius: 4px;
    cursor: pointer;
    transition: all 0.2s;
    letter-spacing: 0.5px;
    text-transform: uppercase;
  }
  .refresh-btn:hover { border-color: var(--accent-ice); color: var(--accent-ice); }
  .refresh-btn.loading { pointer-events: none; opacity: 0.5; }

  /* Tab navigation */
  .tabs {
    display: flex;
    gap: 2px;
    margin-bottom: 24px;
    background: var(--bg-card);
    border-radius: 6px;
    padding: 3px;
    width: fit-content;
  }
  .tab {
    font-family: 'Oswald', sans-serif;
    font-weight: 500;
    font-size: 0.85rem;
    letter-spacing: 1.5px;
    text-transform: uppercase;
    padding: 8px 22px;
    border: none;
    background: transparent;
    color: var(--text-muted);
    cursor: pointer;
    border-radius: 4px;
    transition: all 0.2s;
  }
  .tab:hover { color: var(--text-secondary); }
  .tab.active {
    background: var(--border);
    color: var(--text-primary);
  }

  /* Panels */
  .panel { display: none; }
  .panel.active { display: block; animation: fadeUp 0.3s ease; }
  @keyframes fadeUp {
    from { opacity: 0; transform: translateY(8px); }
    to { opacity: 1; transform: translateY(0); }
  }

  /* Grid layouts */
  .leaders-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 20px;
    margin-bottom: 24px;
  }

  /* Cards */
  .card {
    background: var(--bg-card);
    border: 1px solid var(--border);
    border-radius: 8px;
    overflow: hidden;
    transition: border-color 0.2s;
  }
  .card:hover { border-color: var(--border-bright); }
  .card-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 14px 18px;
    border-bottom: 1px solid var(--border);
  }
  .card-title {
    font-family: 'Oswald', sans-serif;
    font-weight: 600;
    font-size: 0.9rem;
    letter-spacing: 1.5px;
    text-transform: uppercase;
    color: var(--text-secondary);
  }
  .card-accent {
    width: 28px; height: 3px;
    border-radius: 2px;
  }
  .accent-ice { background: var(--accent-ice); box-shadow: 0 0 8px var(--glow-ice); }
  .accent-red { background: var(--accent-red); box-shadow: 0 0 8px var(--glow-red); }
  .accent-gold { background: var(--accent-gold); }

  /* Tables */
  table { width: 100%; border-collapse: collapse; }
  th {
    font-family: 'Source Code Pro', monospace;
    font-size: 0.65rem;
    font-weight: 600;
    color: var(--text-muted);
    letter-spacing: 1px;
    text-transform: uppercase;
    text-align: left;
    padding: 10px 14px;
    border-bottom: 1px solid var(--border);
    position: sticky;
    top: 0;
    background: var(--bg-card);
    z-index: 2;
  }
  th.sortable { cursor: pointer; user-select: none; }
  th.sortable:hover { color: var(--accent-ice); }
  th.sortable::after {
    content: '';
    display: inline-block;
    margin-left: 4px;
    opacity: 0.3;
  }
  th.sort-asc::after { content: '▲'; opacity: 0.8; color: var(--accent-ice); }
  th.sort-desc::after { content: '▼'; opacity: 0.8; color: var(--accent-ice); }
  td {
    font-size: 0.92rem;
    padding: 9px 14px;
    border-bottom: 1px solid rgba(30,35,51,0.5);
    white-space: nowrap;
  }
  tr:hover td { background: var(--bg-card-hover); }

  .rank-cell {
    font-family: 'Source Code Pro', monospace;
    font-size: 0.75rem;
    color: var(--text-muted);
    width: 36px;
  }
  .rank-1 { color: var(--accent-gold); font-weight: 700; }
  .rank-2 { color: #b0bec5; font-weight: 600; }
  .rank-3 { color: #a1887f; font-weight: 600; }

  .player-name {
    font-weight: 600;
    color: var(--text-primary);
    letter-spacing: 0.3px;
  }
  .team-abbr {
    font-family: 'Source Code Pro', monospace;
    font-size: 0.75rem;
    color: var(--text-secondary);
    background: rgba(255,255,255,0.04);
    padding: 2px 7px;
    border-radius: 3px;
    letter-spacing: 0.5px;
  }
  .stat-value {
    font-family: 'Source Code Pro', monospace;
    font-weight: 600;
    font-size: 0.95rem;
    color: var(--accent-ice);
  }
  .stat-value.red { color: var(--accent-red); }
  .stat-value.green { color: var(--accent-green); }

  /* Standings specific */
  .standings-scroll {
    max-height: 600px;
    overflow-y: auto;
    scrollbar-width: thin;
    scrollbar-color: var(--border) transparent;
  }
  .standings-scroll::-webkit-scrollbar { width: 5px; }
  .standings-scroll::-webkit-scrollbar-track { background: transparent; }
  .standings-scroll::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }

  .diff-pos { color: var(--accent-green); font-weight: 600; }
  .diff-neg { color: var(--accent-red); }
  .diff-zero { color: var(--text-muted); }

  .division-header td {
    font-family: 'Oswald', sans-serif;
    font-weight: 600;
    font-size: 0.78rem;
    letter-spacing: 2px;
    text-transform: uppercase;
    color: var(--accent-ice);
    background: rgba(79,195,247,0.05);
    padding: 8px 14px;
    border-bottom: 1px solid var(--border);
  }

  /* Conference filter */
  .filter-bar {
    display: flex;
    gap: 8px;
    margin-bottom: 16px;
    align-items: center;
  }
  .filter-btn {
    font-family: 'Source Code Pro', monospace;
    font-size: 0.7rem;
    letter-spacing: 0.5px;
    text-transform: uppercase;
    padding: 5px 14px;
    border: 1px solid var(--border);
    background: transparent;
    color: var(--text-muted);
    border-radius: 3px;
    cursor: pointer;
    transition: all 0.2s;
  }
  .filter-btn:hover { color: var(--text-secondary); border-color: var(--border-bright); }
  .filter-btn.active { color: var(--accent-ice); border-color: var(--accent-ice); background: var(--glow-ice); }

  /* Schedule cards */
  .schedule-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
    gap: 16px;
  }
  .game-card {
    background: var(--bg-card);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 16px 18px;
    transition: border-color 0.2s;
  }
  .game-card:hover { border-color: var(--border-bright); }
  .game-card.live { border-color: var(--accent-red); box-shadow: 0 0 12px var(--glow-red); }
  .game-meta {
    font-family: 'Source Code Pro', monospace;
    font-size: 0.68rem;
    color: var(--text-muted);
    letter-spacing: 0.5px;
    text-transform: uppercase;
    margin-bottom: 10px;
    display: flex;
    justify-content: space-between;
  }
  .live-badge {
    color: var(--accent-red);
    font-weight: 700;
    animation: pulse-dot 1.5s ease-in-out infinite;
  }
  .game-matchup {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 12px;
  }
  .game-team {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 4px;
    flex: 1;
  }
  .game-team-abbr {
    font-family: 'Oswald', sans-serif;
    font-weight: 700;
    font-size: 1.4rem;
    letter-spacing: 1px;
  }
  .game-team-record {
    font-family: 'Source Code Pro', monospace;
    font-size: 0.65rem;
    color: var(--text-muted);
  }
  .game-score {
    font-family: 'Oswald', sans-serif;
    font-weight: 700;
    font-size: 1.6rem;
    color: var(--text-primary);
    letter-spacing: 2px;
  }
  .game-vs {
    font-family: 'Source Code Pro', monospace;
    font-size: 0.7rem;
    color: var(--text-muted);
  }

  /* Loading & Error */
  .loading-state {
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 60px;
    color: var(--text-muted);
    font-family: 'Source Code Pro', monospace;
    font-size: 0.8rem;
    letter-spacing: 1px;
  }
  .loading-spinner {
    width: 16px; height: 16px;
    border: 2px solid var(--border);
    border-top-color: var(--accent-ice);
    border-radius: 50%;
    animation: spin 0.8s linear infinite;
    margin-right: 10px;
  }
  @keyframes spin { to { transform: rotate(360deg); } }

  .error-state {
    text-align: center;
    padding: 40px;
    color: var(--accent-red);
    font-family: 'Source Code Pro', monospace;
    font-size: 0.8rem;
  }

  .last-updated {
    font-family: 'Source Code Pro', monospace;
    font-size: 0.65rem;
    color: var(--text-muted);
    text-align: right;
    margin-top: 20px;
    letter-spacing: 0.5px;
  }

  /* Responsive */
  @media (max-width: 900px) {
    .leaders-grid { grid-template-columns: 1fr; }
    .header { flex-direction: column; align-items: flex-start; gap: 12px; }
    .header-right { width: 100%; justify-content: flex-start; }
    .schedule-grid { grid-template-columns: 1fr; }
  }
  @media (max-width: 600px) {
    .app { padding: 12px 12px 40px; }
    .logo { font-size: 1.4rem; }
    td, th { padding: 7px 8px; font-size: 0.8rem; }
  }
</style>
</head>
<body>
<div class="app">
  <!-- Header -->
  <header class="header">
    <div class="header-left">
      <div class="logo">NHL<span>REF</span></div>
      <span class="header-tag">2024–25 Season</span>
    </div>
    <div class="header-right">
      <div class="status-dot" id="statusDot"></div>
      <span class="status-text" id="statusText">Connecting...</span>
      <button class="refresh-btn" id="refreshBtn" onclick="refreshAll()">Refresh</button>
    </div>
  </header>

  <!-- Tabs -->
  <div class="tabs">
    <button class="tab active" data-panel="overview" onclick="switchTab(this)">Overview</button>
    <button class="tab" data-panel="standings" onclick="switchTab(this)">Standings</button>
    <button class="tab" data-panel="schedule" onclick="switchTab(this)">Schedule</button>
  </div>

  <!-- OVERVIEW Panel -->
  <div class="panel active" id="panel-overview">
    <div class="leaders-grid">
      <!-- Points Leaders -->
      <div class="card">
        <div class="card-header">
          <span class="card-title">Points Leaders</span>
          <div class="card-accent accent-ice"></div>
        </div>
        <div id="skatersTable">
          <div class="loading-state"><div class="loading-spinner"></div>Loading skaters...</div>
        </div>
      </div>
      <!-- GAA Leaders -->
      <div class="card">
        <div class="card-header">
          <span class="card-title">Goals Against Avg</span>
          <div class="card-accent accent-red"></div>
        </div>
        <div id="goaliesTable">
          <div class="loading-state"><div class="loading-spinner"></div>Loading goalies...</div>
        </div>
      </div>
    </div>

    <!-- Quick Standings (top 10) -->
    <div class="card">
      <div class="card-header">
        <span class="card-title">League Leaders — Top 10</span>
        <div class="card-accent accent-gold"></div>
      </div>
      <div id="quickStandings">
        <div class="loading-state"><div class="loading-spinner"></div>Loading standings...</div>
      </div>
    </div>
  </div>

  <!-- STANDINGS Panel -->
  <div class="panel" id="panel-standings">
    <div class="filter-bar">
      <button class="filter-btn active" data-filter="all" onclick="filterStandings(this, 'all')">All</button>
      <button class="filter-btn" data-filter="eastern" onclick="filterStandings(this, 'Eastern')">Eastern</button>
      <button class="filter-btn" data-filter="western" onclick="filterStandings(this, 'Western')">Western</button>
    </div>
    <div class="card">
      <div class="card-header">
        <span class="card-title">Full Standings</span>
      </div>
      <div class="standings-scroll" id="fullStandings">
        <div class="loading-state"><div class="loading-spinner"></div>Loading standings...</div>
      </div>
    </div>
  </div>

  <!-- SCHEDULE Panel -->
  <div class="panel" id="panel-schedule">
    <div id="scheduleContent">
      <div class="loading-state"><div class="loading-spinner"></div>Loading schedule...</div>
    </div>
  </div>

  <div class="last-updated" id="lastUpdated"></div>
</div>

<script>
const API = 'https://api-web.nhle.com/v1';
let standingsData = [];
let currentFilter = 'all';

// Tab switching
function switchTab(el) {
  document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
  document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
  el.classList.add('active');
  document.getElementById('panel-' + el.dataset.panel).classList.add('active');
}

// Fetch helper with CORS proxy fallback
async function nhlFetch(endpoint) {
  // Try direct first
  try {
    const r = await fetch(API + endpoint);
    if (r.ok) return await r.json();
  } catch(e) {}
  // Fallback: corsproxy
  try {
    const r = await fetch('https://corsproxy.io/?' + encodeURIComponent(API + endpoint));
    if (r.ok) return await r.json();
  } catch(e) {}
  throw new Error('Failed to fetch ' + endpoint);
}

// Render skaters
function renderSkaters(data) {
  const container = document.getElementById('skatersTable');
  try {
    // The response structure: data with array of leader entries
    const players = data.points || data.goals || data.assists || [];
    if (!players.length) { container.innerHTML = '<div class="error-state">No skater data available</div>'; return; }

    let html = '<table><thead><tr><th>#</th><th>Player</th><th>Team</th><th>GP</th><th>PTS</th></tr></thead><tbody>';
    players.slice(0, 10).forEach((p, i) => {
      const rank = i + 1;
      const rankClass = rank <= 3 ? ` rank-${rank}` : '';
      const firstName = p.firstName?.default || '';
      const lastName = p.lastName?.default || '';
      const team = p.teamAbbrev?.default || p.teamAbbrev || '—';
      const value = p.value ?? '—';
      const gp = p.gamesPlayed ?? '—';
      html += `<tr>
        <td class="rank-cell${rankClass}">${rank}</td>
        <td class="player-name">${firstName} ${lastName}</td>
        <td><span class="team-abbr">${team}</span></td>
        <td>${gp}</td>
        <td class="stat-value">${value}</td>
      </tr>`;
    });
    html += '</tbody></table>';
    container.innerHTML = html;
  } catch(e) {
    container.innerHTML = '<div class="error-state">Error parsing skater data</div>';
  }
}

// Render goalies
function renderGoalies(data) {
  const container = document.getElementById('goaliesTable');
  try {
    const goalies = data.goalsAgainstAverage || data.gaa || data.savePctg || data.wins || [];
    if (!goalies.length) { container.innerHTML = '<div class="error-state">No goalie data available</div>'; return; }

    let html = '<table><thead><tr><th>#</th><th>Goalie</th><th>Team</th><th>GP</th><th>GAA</th></tr></thead><tbody>';
    goalies.slice(0, 10).forEach((g, i) => {
      const rank = i + 1;
      const rankClass = rank <= 3 ? ` rank-${rank}` : '';
      const firstName = g.firstName?.default || '';
      const lastName = g.lastName?.default || '';
      const team = g.teamAbbrev?.default || g.teamAbbrev || '—';
      const value = typeof g.value === 'number' ? g.value.toFixed(2) : g.value ?? '—';
      const gp = g.gamesPlayed ?? '—';
      html += `<tr>
        <td class="rank-cell${rankClass}">${rank}</td>
        <td class="player-name">${firstName} ${lastName}</td>
        <td><span class="team-abbr">${team}</span></td>
        <td>${gp}</td>
        <td class="stat-value red">${value}</td>
      </tr>`;
    });
    html += '</tbody></table>';
    container.innerHTML = html;
  } catch(e) {
    container.innerHTML = '<div class="error-state">Error parsing goalie data</div>';
  }
}

// Render standings
function renderStandings(data, quickOnly = false) {
  const teams = data.standings || data || [];
  standingsData = teams;

  // Sort by points (desc), then wins (desc)
  const sorted = [...teams].sort((a, b) => (b.points - a.points) || (b.wins - a.wins));

  if (quickOnly) {
    const container = document.getElementById('quickStandings');
    const top10 = sorted.slice(0, 10);
    let html = '<table><thead><tr><th>#</th><th>Team</th><th>GP</th><th>W</th><th>L</th><th>OTL</th><th>PTS</th><th>DIFF</th></tr></thead><tbody>';
    top10.forEach((t, i) => {
      const rank = i + 1;
      const rankClass = rank <= 3 ? ` rank-${rank}` : '';
      const abbr = t.teamAbbrev?.default || t.teamAbbrev || '—';
      const diff = (t.goalDifferential ?? (t.goalFor - t.goalAgainst)) || 0;
      const diffClass = diff > 0 ? 'diff-pos' : diff < 0 ? 'diff-neg' : 'diff-zero';
      const diffStr = diff > 0 ? `+${diff}` : `${diff}`;
      html += `<tr>
        <td class="rank-cell${rankClass}">${rank}</td>
        <td><span class="team-abbr">${abbr}</span> ${t.teamName?.default || t.teamCommonName?.default || ''}</td>
        <td>${t.gamesPlayed ?? '—'}</td>
        <td>${t.wins ?? '—'}</td>
        <td>${t.losses ?? '—'}</td>
        <td>${t.otLosses ?? '—'}</td>
        <td class="stat-value">${t.points ?? '—'}</td>
        <td class="${diffClass}">${diffStr}</td>
      </tr>`;
    });
    html += '</tbody></table>';
    container.innerHTML = html;
  }

  renderFullStandings(currentFilter);
}

function renderFullStandings(filter) {
  const container = document.getElementById('fullStandings');
  if (!standingsData.length) return;

  // Group by division
  const divisions = {};
  standingsData.forEach(t => {
    const conf = t.conferenceName || 'Unknown';
    const div = t.divisionName || 'Unknown';
    if (filter !== 'all' && conf !== filter) return;
    if (!divisions[div]) divisions[div] = [];
    divisions[div].push(t);
  });

  // Sort each division by points
  Object.values(divisions).forEach(arr => arr.sort((a, b) => (b.points - a.points) || (b.wins - a.wins)));

  // Preferred division order
  const divOrder = ['Atlantic', 'Metropolitan', 'Central', 'Pacific'];
  const sortedDivs = Object.keys(divisions).sort((a, b) => {
    const ai = divOrder.indexOf(a);
    const bi = divOrder.indexOf(b);
    return (ai === -1 ? 99 : ai) - (bi === -1 ? 99 : bi);
  });

  let html = '<table><thead><tr><th>#</th><th>Team</th><th>GP</th><th>W</th><th>L</th><th>OTL</th><th>PTS</th><th>GF</th><th>GA</th><th>DIFF</th><th>STRK</th></tr></thead><tbody>';

  sortedDivs.forEach(div => {
    html += `<tr class="division-header"><td colspan="11">${div}</td></tr>`;
    divisions[div].forEach((t, i) => {
      const abbr = t.teamAbbrev?.default || t.teamAbbrev || '—';
      const diff = (t.goalDifferential ?? (t.goalFor - t.goalAgainst)) || 0;
      const diffClass = diff > 0 ? 'diff-pos' : diff < 0 ? 'diff-neg' : 'diff-zero';
      const diffStr = diff > 0 ? `+${diff}` : `${diff}`;
      const streak = t.streakCode || '—';
      html += `<tr>
        <td class="rank-cell">${i + 1}</td>
        <td><span class="team-abbr">${abbr}</span> ${t.teamName?.default || t.teamCommonName?.default || ''}</td>
        <td>${t.gamesPlayed ?? '—'}</td>
        <td>${t.wins ?? '—'}</td>
        <td>${t.losses ?? '—'}</td>
        <td>${t.otLosses ?? '—'}</td>
        <td class="stat-value">${t.points ?? '—'}</td>
        <td>${t.goalFor ?? '—'}</td>
        <td>${t.goalAgainst ?? '—'}</td>
        <td class="${diffClass}">${diffStr}</td>
        <td style="font-family:'Source Code Pro',monospace;font-size:0.78rem">${streak}</td>
      </tr>`;
    });
  });
  html += '</tbody></table>';
  container.innerHTML = html;
}

function filterStandings(el, filter) {
  document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
  el.classList.add('active');
  currentFilter = filter;
  renderFullStandings(filter);
}

// Render schedule
function renderSchedule(data) {
  const container = document.getElementById('scheduleContent');
  try {
    const gameWeek = data.gameWeek || [];
    if (!gameWeek.length) { container.innerHTML = '<div class="error-state">No games scheduled</div>'; return; }

    let html = '';
    gameWeek.forEach(day => {
      const dateStr = new Date(day.date + 'T12:00:00').toLocaleDateString('en-US', { weekday: 'long', month: 'short', day: 'numeric' });
      html += `<div style="margin-bottom:24px">
        <div style="font-family:'Oswald',sans-serif;font-weight:600;font-size:0.85rem;letter-spacing:1.5px;text-transform:uppercase;color:var(--text-secondary);margin-bottom:12px;padding-left:2px">${dateStr}</div>
        <div class="schedule-grid">`;

      if (!day.games || !day.games.length) {
        html += '<div class="game-card"><div style="padding:20px;text-align:center;color:var(--text-muted);font-size:0.85rem">No games</div></div>';
      } else {
        day.games.forEach(game => {
          const state = game.gameState; // FUT, LIVE, OFF, FINAL, CRIT
          const isLive = state === 'LIVE' || state === 'CRIT';
          const isFinal = state === 'OFF' || state === 'FINAL';

          const away = game.awayTeam || {};
          const home = game.homeTeam || {};
          const awayAbbr = away.abbrev || '—';
          const homeAbbr = home.abbrev || '—';

          let statusStr = '';
          if (isLive) {
            const period = game.periodDescriptor?.number || '';
            const clock = game.clock?.timeRemaining || '';
            statusStr = `<span class="live-badge">● LIVE</span> <span>${period ? 'P' + period : ''} ${clock}</span>`;
          } else if (isFinal) {
            statusStr = 'Final' + (game.periodDescriptor?.number > 3 ? ' / OT' : '');
          } else {
            const time = game.startTimeUTC ? new Date(game.startTimeUTC).toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' }) : '';
            statusStr = time;
          }

          const showScore = isLive || isFinal;
          const awayScore = away.score ?? 0;
          const homeScore = home.score ?? 0;

          html += `<div class="game-card${isLive ? ' live' : ''}">
            <div class="game-meta">
              <span>${game.venue?.default || ''}</span>
              <span>${statusStr}</span>
            </div>
            <div class="game-matchup">
              <div class="game-team">
                <div class="game-team-abbr">${awayAbbr}</div>
              </div>
              <div style="text-align:center">
                ${showScore
                  ? `<div class="game-score">${awayScore} — ${homeScore}</div>`
                  : `<div class="game-vs">VS</div>`
                }
              </div>
              <div class="game-team">
                <div class="game-team-abbr">${homeAbbr}</div>
              </div>
            </div>
          </div>`;
        });
      }
      html += '</div></div>';
    });
    container.innerHTML = html;
  } catch(e) {
    container.innerHTML = '<div class="error-state">Error loading schedule</div>';
  }
}

// Main fetch
async function refreshAll() {
  const btn = document.getElementById('refreshBtn');
  const statusText = document.getElementById('statusText');
  const statusDot = document.getElementById('statusDot');

  btn.classList.add('loading');
  btn.textContent = 'Loading...';
  statusText.textContent = 'Fetching...';
  statusDot.style.background = 'var(--accent-orange)';

  let errors = 0;

  try {
    const skaters = await nhlFetch('/skater-stats-leaders/current/2?categories=points&limit=10');
    renderSkaters(skaters);
  } catch(e) { errors++; document.getElementById('skatersTable').innerHTML = '<div class="error-state">Could not load skaters — CORS or API issue. Try opening this file locally or via a server.</div>'; }

  try {
    const goalies = await nhlFetch('/goalie-stats-leaders/current/2?categories=goalsAgainstAverage&limit=10');
    renderGoalies(goalies);
  } catch(e) { errors++; document.getElementById('goaliesTable').innerHTML = '<div class="error-state">Could not load goalies</div>'; }

  try {
    const standings = await nhlFetch('/standings/now');
    renderStandings(standings, true);
  } catch(e) { errors++; document.getElementById('quickStandings').innerHTML = '<div class="error-state">Could not load standings</div>'; document.getElementById('fullStandings').innerHTML = '<div class="error-state">Could not load standings</div>'; }

  try {
    const schedule = await nhlFetch('/schedule/now');
    renderSchedule(schedule);
  } catch(e) { errors++; document.getElementById('scheduleContent').innerHTML = '<div class="error-state">Could not load schedule</div>'; }

  btn.classList.remove('loading');
  btn.textContent = 'Refresh';

  if (errors === 0) {
    statusText.textContent = 'Live';
    statusDot.style.background = 'var(--accent-green)';
    statusDot.style.boxShadow = '0 0 6px var(--accent-green)';
  } else if (errors < 4) {
    statusText.textContent = 'Partial';
    statusDot.style.background = 'var(--accent-orange)';
    statusDot.style.boxShadow = '0 0 6px var(--accent-orange)';
  } else {
    statusText.textContent = 'Offline';
    statusDot.style.background = 'var(--accent-red)';
    statusDot.style.boxShadow = '0 0 6px var(--accent-red)';
  }

  document.getElementById('lastUpdated').textContent = 'Last updated: ' + new Date().toLocaleTimeString();
}

// Auto-refresh every 5 min
setInterval(refreshAll, 300000);

// Initial load
refreshAll();
</script>
</body>
</html>
