<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>NHL Quick Reference</title>
<link href="https://fonts.googleapis.com/css2?family=Oswald:wght@400;500;600;700&family=Source+Code+Pro:wght@400;500;600&family=Barlow+Condensed:wght@400;500;600;700&display=swap" rel="stylesheet">
<style>
  :root {
    --bg-deep: #0a0c10;
    --bg-card: #12151c;
    --bg-card-hover: #181c26;
    --border: #1e2333;
    --border-bright: #2a3050;
    --text-primary: #e8eaf0;
    --text-secondary: #7a82a0;
    --text-muted: #4a5070;
    --accent-ice: #4fc3f7;
    --accent-red: #ef5350;
    --accent-green: #66bb6a;
    --accent-gold: #ffd54f;
    --accent-orange: #ff9800;
    --accent-purple: #b388ff;
    --glow-ice: rgba(79, 195, 247, 0.15);
    --glow-red: rgba(239, 83, 80, 0.15);
  }

  * { margin: 0; padding: 0; box-sizing: border-box; }

  body {
    background: var(--bg-deep);
    color: var(--text-primary);
    font-family: 'Barlow Condensed', sans-serif;
    min-height: 100vh;
    overflow-x: hidden;
  }

  /* Subtle ice rink texture */
  body::before {
    content: '';
    position: fixed;
    inset: 0;
    background:
      radial-gradient(ellipse 80% 50% at 50% 0%, rgba(79,195,247,0.03) 0%, transparent 60%),
      radial-gradient(ellipse 60% 40% at 80% 100%, rgba(239,83,80,0.02) 0%, transparent 50%);
    pointer-events: none;
    z-index: 0;
  }

  .app { position: relative; z-index: 1; max-width: 1400px; margin: 0 auto; padding: 20px 24px 60px; }

  /* Header */
  .header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 20px 0 28px;
    border-bottom: 1px solid var(--border);
    margin-bottom: 28px;
  }
  .header-left { display: flex; align-items: baseline; gap: 16px; }
  .logo {
    font-family: 'Oswald', sans-serif;
    font-weight: 700;
    font-size: 1.8rem;
    letter-spacing: 2px;
    text-transform: uppercase;
    color: var(--text-primary);
  }
  .logo span { color: var(--accent-ice); }
  .header-tag {
    font-family: 'Source Code Pro', monospace;
    font-size: 0.72rem;
    color: var(--text-muted);
    letter-spacing: 1px;
    text-transform: uppercase;
    border: 1px solid var(--border);
    padding: 3px 10px;
    border-radius: 3px;
  }
  .header-right { display: flex; align-items: center; gap: 14px; }
  .status-dot {
    width: 7px; height: 7px;
    background: var(--accent-green);
    border-radius: 50%;
    box-shadow: 0 0 6px var(--accent-green);
    animation: pulse-dot 2s ease-in-out infinite;
  }
  @keyframes pulse-dot {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.4; }
  }
  .status-text {
    font-family: 'Source Code Pro', monospace;
    font-size: 0.72rem;
    color: var(--text-secondary);
    letter-spacing: 0.5px;
  }
  .refresh-btn {
    background: transparent;
    border: 1px solid var(--border);
    color: var(--text-secondary);
    font-family: 'Source Code Pro', monospace;
    font-size: 0.72rem;
    padding: 5px 14px;
    border-radius: 4px;
    cursor: pointer;
    transition: all 0.2s;
    letter-spacing: 0.5px;
    text-transform: uppercase;
  }
  .refresh-btn:hover { border-color: var(--accent-ice); color: var(--accent-ice); }
  .refresh-btn.loading { pointer-events: none; opacity: 0.5; }

  /* Tab navigation */
  .tabs {
    display: flex;
    gap: 2px;
    margin-bottom: 24px;
    background: var(--bg-card);
    border-radius: 6px;
    padding: 3px;
    width: fit-content;
  }
  .tab {
    font-family: 'Oswald', sans-serif;
    font-weight: 500;
    font-size: 0.85rem;
    letter-spacing: 1.5px;
    text-transform: uppercase;
    padding: 8px 22px;
    border: none;
    background: transparent;
    color: var(--text-muted);
    cursor: pointer;
    border-radius: 4px;
    transition: all 0.2s;
  }
  .tab:hover { color: var(--text-secondary); }
  .tab.active {
    background: var(--border);
    color: var(--text-primary);
  }

  /* Panels */
  .panel { display: none; }
  .panel.active { display: block; animation: fadeUp 0.3s ease; }
  @keyframes fadeUp {
    from { opacity: 0; transform: translateY(8px); }
    to { opacity: 1; transform: translateY(0); }
  }

  /* Grid layouts */
  .leaders-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 20px;
    margin-bottom: 24px;
  }

  /* Cards */
  .card {
    background: var(--bg-card);
    border: 1px solid var(--border);
    border-radius: 8px;
    overflow: hidden;
    transition: border-color 0.2s;
  }
  .card:hover { border-color: var(--border-bright); }
  .card-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 14px 18px;
    border-bottom: 1px solid var(--border);
  }
  .card-title {
    font-family: 'Oswald', sans-serif;
    font-weight: 600;
    font-size: 0.9rem;
    letter-spacing: 1.5px;
    text-transform: uppercase;
    color: var(--text-secondary);
  }
  .card-accent {
    width: 28px; height: 3px;
    border-radius: 2px;
  }
  .accent-ice { background: var(--accent-ice); box-shadow: 0 0 8px var(--glow-ice); }
  .accent-red { background: var(--accent-red); box-shadow: 0 0 8px var(--glow-red); }
  .accent-gold { background: var(--accent-gold); }
  .accent-green { background: var(--accent-green); }
  .accent-purple { background: var(--accent-purple); }

  /* Tables */
  table { width: 100%; border-collapse: collapse; }
  th {
    font-family: 'Source Code Pro', monospace;
    font-size: 0.65rem;
    font-weight: 600;
    color: var(--text-muted);
    letter-spacing: 1px;
    text-transform: uppercase;
    text-align: left;
    padding: 10px 14px;
    border-bottom: 1px solid var(--border);
    position: sticky;
    top: 0;
    background: var(--bg-card);
    z-index: 2;
  }
  th.sortable { cursor: pointer; user-select: none; }
  th.sortable:hover { color: var(--accent-ice); }
  th.sortable::after {
    content: ' ⇅';
    opacity: 0.3;
    font-size: 0.6rem;
  }
  th.sort-asc::after { content: ' ▲'; opacity: 0.8; color: var(--accent-ice); }
  th.sort-desc::after { content: ' ▼'; opacity: 0.8; color: var(--accent-ice); }
  td {
    font-size: 0.92rem;
    padding: 9px 14px;
    border-bottom: 1px solid rgba(30,35,51,0.5);
    white-space: nowrap;
  }
  tr:hover td { background: var(--bg-card-hover); }

  .rank-cell {
    font-family: 'Source Code Pro', monospace;
    font-size: 0.75rem;
    color: var(--text-muted);
    width: 36px;
  }
  .rank-1 { color: var(--accent-gold); font-weight: 700; }
  .rank-2 { color: #b0bec5; font-weight: 600; }
  .rank-3 { color: #a1887f; font-weight: 600; }

  .player-name {
    font-weight: 600;
    color: var(--text-primary);
    letter-spacing: 0.3px;
  }
  .team-abbr {
    font-family: 'Source Code Pro', monospace;
    font-size: 0.75rem;
    color: var(--text-secondary);
    background: rgba(255,255,255,0.04);
    padding: 2px 7px;
    border-radius: 3px;
    letter-spacing: 0.5px;
  }
  .stat-value {
    font-family: 'Source Code Pro', monospace;
    font-weight: 600;
    font-size: 0.95rem;
    color: var(--accent-ice);
  }
  .stat-value.red { color: var(--accent-red); }
  .stat-value.green { color: var(--accent-green); }
  .stat-value.gold { color: var(--accent-gold); }
  .stat-value.purple { color: var(--accent-purple); }

  /* Standings specific */
  .standings-scroll {
    max-height: 600px;
    overflow-y: auto;
    scrollbar-width: thin;
    scrollbar-color: var(--border) transparent;
  }
  .standings-scroll::-webkit-scrollbar { width: 5px; }
  .standings-scroll::-webkit-scrollbar-track { background: transparent; }
  .standings-scroll::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }

  .diff-pos { color: var(--accent-green); font-weight: 600; }
  .diff-neg { color: var(--accent-red); }
  .diff-zero { color: var(--text-muted); }

  .division-header td {
    font-family: 'Oswald', sans-serif;
    font-weight: 600;
    font-size: 0.78rem;
    letter-spacing: 2px;
    text-transform: uppercase;
    color: var(--accent-ice);
    background: rgba(79,195,247,0.05);
    padding: 8px 14px;
    border-bottom: 1px solid var(--border);
  }

  /* Conference filter */
  .filter-bar {
    display: flex;
    gap: 8px;
    margin-bottom: 16px;
    align-items: center;
    flex-wrap: wrap;
  }
  .filter-btn {
    font-family: 'Source Code Pro', monospace;
    font-size: 0.7rem;
    letter-spacing: 0.5px;
    text-transform: uppercase;
    padding: 5px 14px;
    border: 1px solid var(--border);
    background: transparent;
    color: var(--text-muted);
    border-radius: 3px;
    cursor: pointer;
    transition: all 0.2s;
  }
  .filter-btn:hover { color: var(--text-secondary); border-color: var(--border-bright); }
  .filter-btn.active { color: var(--accent-ice); border-color: var(--accent-ice); background: var(--glow-ice); }

  /* Schedule cards */
  .schedule-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
    gap: 16px;
  }
  .game-card {
    background: var(--bg-card);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 16px 18px;
    transition: border-color 0.2s;
  }
  .game-card:hover { border-color: var(--border-bright); }
  .game-card.live { border-color: var(--accent-red); box-shadow: 0 0 12px var(--glow-red); }
  .game-meta {
    font-family: 'Source Code Pro', monospace;
    font-size: 0.68rem;
    color: var(--text-muted);
    letter-spacing: 0.5px;
    text-transform: uppercase;
    margin-bottom: 10px;
    display: flex;
    justify-content: space-between;
  }
  .live-badge {
    color: var(--accent-red);
    font-weight: 700;
    animation: pulse-dot 1.5s ease-in-out infinite;
  }
  .game-matchup {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 12px;
  }
  .game-team {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 4px;
    flex: 1;
  }
  .game-team-abbr {
    font-family: 'Oswald', sans-serif;
    font-weight: 700;
    font-size: 1.4rem;
    letter-spacing: 1px;
  }
  .game-team-record {
    font-family: 'Source Code Pro', monospace;
    font-size: 0.65rem;
    color: var(--text-muted);
  }
  .game-score {
    font-family: 'Oswald', sans-serif;
    font-weight: 700;
    font-size: 1.6rem;
    color: var(--text-primary);
    letter-spacing: 2px;
  }
  .game-vs {
    font-family: 'Source Code Pro', monospace;
    font-size: 0.7rem;
    color: var(--text-muted);
  }
  .game-winner .game-team-abbr { color: var(--accent-green); }

  /* Teams tab */
  .teams-scroll {
    max-height: 700px;
    overflow-y: auto;
    scrollbar-width: thin;
    scrollbar-color: var(--border) transparent;
  }
  .teams-scroll::-webkit-scrollbar { width: 5px; }
  .teams-scroll::-webkit-scrollbar-track { background: transparent; }
  .teams-scroll::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }

  /* Loading & Error */
  .loading-state {
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 60px;
    color: var(--text-muted);
    font-family: 'Source Code Pro', monospace;
    font-size: 0.8rem;
    letter-spacing: 1px;
  }
  .loading-spinner {
    width: 16px; height: 16px;
    border: 2px solid var(--border);
    border-top-color: var(--accent-ice);
    border-radius: 50%;
    animation: spin 0.8s linear infinite;
    margin-right: 10px;
  }
  @keyframes spin { to { transform: rotate(360deg); } }

  .error-state {
    text-align: center;
    padding: 40px;
    color: var(--accent-red);
    font-family: 'Source Code Pro', monospace;
    font-size: 0.8rem;
  }

  .last-updated {
    font-family: 'Source Code Pro', monospace;
    font-size: 0.65rem;
    color: var(--text-muted);
    text-align: right;
    margin-top: 20px;
    letter-spacing: 0.5px;
  }

  /* Today highlight in schedule */
  .today-label {
    display: inline-block;
    font-family: 'Source Code Pro', monospace;
    font-size: 0.6rem;
    background: var(--accent-ice);
    color: var(--bg-deep);
    padding: 1px 6px;
    border-radius: 2px;
    margin-left: 8px;
    font-weight: 600;
    letter-spacing: 0.5px;
    vertical-align: middle;
  }

  /* Responsive */
  @media (max-width: 900px) {
    .leaders-grid { grid-template-columns: 1fr; }
    .header { flex-direction: column; align-items: flex-start; gap: 12px; }
    .header-right { width: 100%; justify-content: flex-start; }
    .schedule-grid { grid-template-columns: 1fr; }
  }
  @media (max-width: 600px) {
    .app { padding: 12px 12px 40px; }
    .logo { font-size: 1.4rem; }
    td, th { padding: 7px 8px; font-size: 0.8rem; }
    .tabs { width: 100%; overflow-x: auto; }
  }
</style>
</head>
<body>
<div class="app">
  <!-- Header -->
  <header class="header">
    <div class="header-left">
      <div class="logo">NHL<span>REF</span></div>
      <span class="header-tag" id="seasonTag">Loading...</span>
    </div>
    <div class="header-right">
      <div class="status-dot" id="statusDot"></div>
      <span class="status-text" id="statusText">Connecting...</span>
      <button class="refresh-btn" id="refreshBtn" onclick="refreshAll()">Refresh</button>
    </div>
  </header>

  <!-- Tabs -->
  <div class="tabs">
    <button class="tab active" data-panel="overview" onclick="switchTab(this)">Overview</button>
    <button class="tab" data-panel="standings" onclick="switchTab(this)">Standings</button>
    <button class="tab" data-panel="teams" onclick="switchTab(this)">Teams</button>
    <button class="tab" data-panel="schedule" onclick="switchTab(this)">Schedule</button>
  </div>

  <!-- OVERVIEW Panel -->
  <div class="panel active" id="panel-overview">
    <div class="leaders-grid">
      <!-- Points Leaders -->
      <div class="card">
        <div class="card-header">
          <span class="card-title">Points Leaders</span>
          <div class="card-accent accent-ice"></div>
        </div>
        <div id="pointsLeadersTable">
          <div class="loading-state"><div class="loading-spinner"></div>Loading...</div>
        </div>
      </div>
      <!-- Goals Leaders -->
      <div class="card">
        <div class="card-header">
          <span class="card-title">Goals Leaders</span>
          <div class="card-accent accent-red"></div>
        </div>
        <div id="goalsLeadersTable">
          <div class="loading-state"><div class="loading-spinner"></div>Loading...</div>
        </div>
      </div>
      <!-- Assists Leaders -->
      <div class="card">
        <div class="card-header">
          <span class="card-title">Assists Leaders</span>
          <div class="card-accent accent-green"></div>
        </div>
        <div id="assistsLeadersTable">
          <div class="loading-state"><div class="loading-spinner"></div>Loading...</div>
        </div>
      </div>
      <!-- GAA Leaders -->
      <div class="card">
        <div class="card-header">
          <span class="card-title">Goals Against Avg</span>
          <div class="card-accent accent-purple"></div>
        </div>
        <div id="goaliesTable">
          <div class="loading-state"><div class="loading-spinner"></div>Loading...</div>
        </div>
      </div>
    </div>

    <!-- Quick Standings (top 10) -->
    <div class="card">
      <div class="card-header">
        <span class="card-title">League Leaders — Top 10</span>
        <div class="card-accent accent-gold"></div>
      </div>
      <div id="quickStandings">
        <div class="loading-state"><div class="loading-spinner"></div>Loading standings...</div>
      </div>
    </div>
  </div>

  <!-- STANDINGS Panel -->
  <div class="panel" id="panel-standings">
    <div class="filter-bar">
      <button class="filter-btn active" data-filter="all" onclick="filterStandings(this, 'all')">All</button>
      <button class="filter-btn" data-filter="eastern" onclick="filterStandings(this, 'Eastern')">Eastern</button>
      <button class="filter-btn" data-filter="western" onclick="filterStandings(this, 'Western')">Western</button>
      <span style="margin-left:8px;width:1px;height:18px;background:var(--border);display:inline-block"></span>
      <button class="filter-btn" data-filter="wildcard" onclick="filterStandings(this, 'wildcard')">Wild Card</button>
    </div>
    <div class="card">
      <div class="card-header">
        <span class="card-title">Full Standings</span>
      </div>
      <div class="standings-scroll" id="fullStandings">
        <div class="loading-state"><div class="loading-spinner"></div>Loading standings...</div>
      </div>
    </div>
  </div>

  <!-- TEAMS Panel -->
  <div class="panel" id="panel-teams">
    <div class="filter-bar">
      <button class="filter-btn active" onclick="filterTeams(this, 'all')">All</button>
      <button class="filter-btn" onclick="filterTeams(this, 'Eastern')">Eastern</button>
      <button class="filter-btn" onclick="filterTeams(this, 'Western')">Western</button>
    </div>
    <div class="card">
      <div class="card-header">
        <span class="card-title">Team Statistics</span>
      </div>
      <div class="teams-scroll" id="teamsContent">
        <div class="loading-state"><div class="loading-spinner"></div>Loading teams...</div>
      </div>
    </div>
  </div>

  <!-- SCHEDULE Panel -->
  <div class="panel" id="panel-schedule">
    <div id="scheduleContent">
      <div class="loading-state"><div class="loading-spinner"></div>Loading schedule...</div>
    </div>
  </div>

  <div class="last-updated" id="lastUpdated"></div>
</div>

<script>
const API = 'https://api-web.nhle.com/v1';
let standingsData = [];
let currentFilter = 'all';
let currentTeamFilter = 'all';
let teamsSortState = { col: 'points', dir: 'desc' };

// ─── Dynamic season tag ───
function updateSeasonTag() {
  const now = new Date();
  const year = now.getFullYear();
  const month = now.getMonth(); // 0-indexed
  // NHL season spans Oct–Jun: if Jul–Sep, show upcoming season; otherwise current
  const startYear = month >= 9 ? year : year - 1;
  const endYear = startYear + 1;
  const shortEnd = String(endYear).slice(-2);
  document.getElementById('seasonTag').textContent = `${startYear}–${shortEnd} Season`;
}

// ─── Tab switching ───
function switchTab(el) {
  document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
  document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
  el.classList.add('active');
  document.getElementById('panel-' + el.dataset.panel).classList.add('active');
}

// ─── Fetch helper with CORS proxy fallback ───
async function nhlFetch(endpoint) {
  try {
    const r = await fetch(API + endpoint);
    if (r.ok) return await r.json();
  } catch(e) {}
  try {
    const r = await fetch('https://corsproxy.io/?' + encodeURIComponent(API + endpoint));
    if (r.ok) return await r.json();
  } catch(e) {}
  throw new Error('Failed to fetch ' + endpoint);
}

// ─── Render skater leaders (generic) ───
function renderSkaterLeaders(data, containerId, category, statLabel, colorClass) {
  const container = document.getElementById(containerId);
  try {
    const players = data[category] || [];
    if (!players.length) { container.innerHTML = '<div class="error-state">No data available</div>'; return; }

    let html = `<table><thead><tr><th>#</th><th>Player</th><th>Team</th><th>GP</th><th>${statLabel}</th></tr></thead><tbody>`;
    players.slice(0, 10).forEach((p, i) => {
      const rank = i + 1;
      const rankClass = rank <= 3 ? ` rank-${rank}` : '';
      const firstName = p.firstName?.default || '';
      const lastName = p.lastName?.default || '';
      const team = p.teamAbbrev?.default || p.teamAbbrev || '—';
      const value = p.value ?? '—';
      const gp = p.gamesPlayed ?? '—';
      html += `<tr>
        <td class="rank-cell${rankClass}">${rank}</td>
        <td class="player-name">${firstName} ${lastName}</td>
        <td><span class="team-abbr">${team}</span></td>
        <td>${gp}</td>
        <td class="stat-value ${colorClass}">${value}</td>
      </tr>`;
    });
    html += '</tbody></table>';
    container.innerHTML = html;
  } catch(e) {
    container.innerHTML = '<div class="error-state">Error parsing data</div>';
  }
}

// ─── Render goalies ───
function renderGoalies(data) {
  const container = document.getElementById('goaliesTable');
  try {
    const goalies = data.goalsAgainstAverage || data.gaa || data.savePctg || data.wins || [];
    if (!goalies.length) { container.innerHTML = '<div class="error-state">No goalie data available</div>'; return; }

    let html = '<table><thead><tr><th>#</th><th>Goalie</th><th>Team</th><th>GP</th><th>GAA</th></tr></thead><tbody>';
    goalies.slice(0, 10).forEach((g, i) => {
      const rank = i + 1;
      const rankClass = rank <= 3 ? ` rank-${rank}` : '';
      const firstName = g.firstName?.default || '';
      const lastName = g.lastName?.default || '';
      const team = g.teamAbbrev?.default || g.teamAbbrev || '—';
      const value = typeof g.value === 'number' ? g.value.toFixed(2) : g.value ?? '—';
      const gp = g.gamesPlayed ?? '—';
      html += `<tr>
        <td class="rank-cell${rankClass}">${rank}</td>
        <td class="player-name">${firstName} ${lastName}</td>
        <td><span class="team-abbr">${team}</span></td>
        <td>${gp}</td>
        <td class="stat-value purple">${value}</td>
      </tr>`;
    });
    html += '</tbody></table>';
    container.innerHTML = html;
  } catch(e) {
    container.innerHTML = '<div class="error-state">Error parsing goalie data</div>';
  }
}

// ─── Render standings ───
function renderStandings(data, quickOnly = false) {
  const teams = data.standings || data || [];
  standingsData = teams;

  const sorted = [...teams].sort((a, b) => (b.points - a.points) || (b.wins - a.wins));

  if (quickOnly) {
    const container = document.getElementById('quickStandings');
    const top10 = sorted.slice(0, 10);
    let html = '<table><thead><tr><th>#</th><th>Team</th><th>GP</th><th>W</th><th>L</th><th>OTL</th><th>PTS</th><th>DIFF</th></tr></thead><tbody>';
    top10.forEach((t, i) => {
      const rank = i + 1;
      const rankClass = rank <= 3 ? ` rank-${rank}` : '';
      const abbr = t.teamAbbrev?.default || t.teamAbbrev || '—';
      const diff = (t.goalDifferential ?? (t.goalFor - t.goalAgainst)) || 0;
      const diffClass = diff > 0 ? 'diff-pos' : diff < 0 ? 'diff-neg' : 'diff-zero';
      const diffStr = diff > 0 ? `+${diff}` : `${diff}`;
      html += `<tr>
        <td class="rank-cell${rankClass}">${rank}</td>
        <td><span class="team-abbr">${abbr}</span> ${t.teamName?.default || t.teamCommonName?.default || ''}</td>
        <td>${t.gamesPlayed ?? '—'}</td>
        <td>${t.wins ?? '—'}</td>
        <td>${t.losses ?? '—'}</td>
        <td>${t.otLosses ?? '—'}</td>
        <td class="stat-value">${t.points ?? '—'}</td>
        <td class="${diffClass}">${diffStr}</td>
      </tr>`;
    });
    html += '</tbody></table>';
    container.innerHTML = html;
  }

  renderFullStandings(currentFilter);
}

function renderFullStandings(filter) {
  const container = document.getElementById('fullStandings');
  if (!standingsData.length) return;

  if (filter === 'wildcard') {
    renderWildCard(container);
    return;
  }

  const divisions = {};
  standingsData.forEach(t => {
    const conf = t.conferenceName || 'Unknown';
    const div = t.divisionName || 'Unknown';
    if (filter !== 'all' && conf !== filter) return;
    if (!divisions[div]) divisions[div] = [];
    divisions[div].push(t);
  });

  Object.values(divisions).forEach(arr => arr.sort((a, b) => (b.points - a.points) || (b.wins - a.wins)));

  const divOrder = ['Atlantic', 'Metropolitan', 'Central', 'Pacific'];
  const sortedDivs = Object.keys(divisions).sort((a, b) => {
    const ai = divOrder.indexOf(a);
    const bi = divOrder.indexOf(b);
    return (ai === -1 ? 99 : ai) - (bi === -1 ? 99 : bi);
  });

  let html = '<table><thead><tr><th>#</th><th>Team</th><th>GP</th><th>W</th><th>L</th><th>OTL</th><th>PTS</th><th>GF</th><th>GA</th><th>DIFF</th><th>STRK</th></tr></thead><tbody>';

  sortedDivs.forEach(div => {
    html += `<tr class="division-header"><td colspan="11">${div}</td></tr>`;
    divisions[div].forEach((t, i) => {
      const abbr = t.teamAbbrev?.default || t.teamAbbrev || '—';
      const diff = (t.goalDifferential ?? (t.goalFor - t.goalAgainst)) || 0;
      const diffClass = diff > 0 ? 'diff-pos' : diff < 0 ? 'diff-neg' : 'diff-zero';
      const diffStr = diff > 0 ? `+${diff}` : `${diff}`;
      const streak = t.streakCode || '—';
      html += `<tr>
        <td class="rank-cell">${i + 1}</td>
        <td><span class="team-abbr">${abbr}</span> ${t.teamName?.default || t.teamCommonName?.default || ''}</td>
        <td>${t.gamesPlayed ?? '—'}</td>
        <td>${t.wins ?? '—'}</td>
        <td>${t.losses ?? '—'}</td>
        <td>${t.otLosses ?? '—'}</td>
        <td class="stat-value">${t.points ?? '—'}</td>
        <td>${t.goalFor ?? '—'}</td>
        <td>${t.goalAgainst ?? '—'}</td>
        <td class="${diffClass}">${diffStr}</td>
        <td style="font-family:'Source Code Pro',monospace;font-size:0.78rem">${streak}</td>
      </tr>`;
    });
  });
  html += '</tbody></table>';
  container.innerHTML = html;
}

// ─── Wild Card view ───
function renderWildCard(container) {
  const conferences = { Eastern: {}, Western: {} };

  standingsData.forEach(t => {
    const conf = t.conferenceName || 'Unknown';
    const div = t.divisionName || 'Unknown';
    if (!conferences[conf]) return;
    if (!conferences[conf][div]) conferences[conf][div] = [];
    conferences[conf][div].push(t);
  });

  let html = '<table><thead><tr><th>#</th><th>Team</th><th>GP</th><th>W</th><th>L</th><th>OTL</th><th>PTS</th><th>DIFF</th></tr></thead><tbody>';

  ['Eastern', 'Western'].forEach(conf => {
    const divs = conferences[conf];
    const divNames = Object.keys(divs);

    // Top 3 from each division
    divNames.forEach(div => {
      divs[div].sort((a, b) => (b.points - a.points) || (b.wins - a.wins));
    });

    html += `<tr class="division-header"><td colspan="8">${conf} Conference</td></tr>`;

    divNames.forEach(div => {
      const top3 = divs[div].slice(0, 3);
      html += `<tr class="division-header"><td colspan="8" style="color:var(--text-secondary);font-size:0.7rem;padding:5px 14px">${div} — Top 3</td></tr>`;
      top3.forEach((t, i) => {
        html += buildStandingsRow(t, i + 1);
      });
    });

    // Wild Card spots: all teams outside top 3, sorted by points
    const wildCards = [];
    divNames.forEach(div => {
      divs[div].slice(3).forEach(t => wildCards.push(t));
    });
    wildCards.sort((a, b) => (b.points - a.points) || (b.wins - a.wins));

    html += `<tr class="division-header"><td colspan="8" style="color:var(--accent-orange);font-size:0.7rem;padding:5px 14px">Wild Card</td></tr>`;
    wildCards.forEach((t, i) => {
      html += buildStandingsRow(t, i + 1);
    });
  });

  html += '</tbody></table>';
  container.innerHTML = html;
}

function buildStandingsRow(t, rank) {
  const abbr = t.teamAbbrev?.default || t.teamAbbrev || '—';
  const diff = (t.goalDifferential ?? (t.goalFor - t.goalAgainst)) || 0;
  const diffClass = diff > 0 ? 'diff-pos' : diff < 0 ? 'diff-neg' : 'diff-zero';
  const diffStr = diff > 0 ? `+${diff}` : `${diff}`;
  return `<tr>
    <td class="rank-cell">${rank}</td>
    <td><span class="team-abbr">${abbr}</span> ${t.teamName?.default || t.teamCommonName?.default || ''}</td>
    <td>${t.gamesPlayed ?? '—'}</td>
    <td>${t.wins ?? '—'}</td>
    <td>${t.losses ?? '—'}</td>
    <td>${t.otLosses ?? '—'}</td>
    <td class="stat-value">${t.points ?? '—'}</td>
    <td class="${diffClass}">${diffStr}</td>
  </tr>`;
}

function filterStandings(el, filter) {
  document.querySelectorAll('#panel-standings .filter-btn').forEach(b => b.classList.remove('active'));
  el.classList.add('active');
  currentFilter = filter;
  renderFullStandings(filter);
}

// ─── Teams tab ───
function renderTeams() {
  renderTeamsTable(currentTeamFilter);
}

function renderTeamsTable(filter) {
  const container = document.getElementById('teamsContent');
  if (!standingsData.length) return;

  let teams = [...standingsData];
  if (filter !== 'all') {
    teams = teams.filter(t => (t.conferenceName || '') === filter);
  }

  // Sort
  const { col, dir } = teamsSortState;
  teams.sort((a, b) => {
    let av = getTeamSortValue(a, col);
    let bv = getTeamSortValue(b, col);
    if (typeof av === 'string') { av = av.toLowerCase(); bv = bv.toLowerCase(); }
    if (av < bv) return dir === 'asc' ? -1 : 1;
    if (av > bv) return dir === 'asc' ? 1 : -1;
    return 0;
  });

  const cols = [
    { key: 'team', label: 'Team', sortable: true },
    { key: 'gamesPlayed', label: 'GP', sortable: true },
    { key: 'wins', label: 'W', sortable: true },
    { key: 'losses', label: 'L', sortable: true },
    { key: 'otLosses', label: 'OTL', sortable: true },
    { key: 'points', label: 'PTS', sortable: true },
    { key: 'pointPctg', label: 'PT%', sortable: true },
    { key: 'goalFor', label: 'GF', sortable: true },
    { key: 'goalAgainst', label: 'GA', sortable: true },
    { key: 'diff', label: 'DIFF', sortable: true },
    { key: 'regulationWins', label: 'RW', sortable: true },
    { key: 'streakCode', label: 'STRK', sortable: false },
  ];

  let html = '<table><thead><tr>';
  cols.forEach(c => {
    const sortClass = c.sortable ? ' sortable' : '';
    const activeClass = col === c.key ? (dir === 'asc' ? ' sort-asc' : ' sort-desc') : '';
    const onclick = c.sortable ? ` onclick="sortTeams('${c.key}')"` : '';
    html += `<th class="${sortClass}${activeClass}"${onclick}>${c.label}</th>`;
  });
  html += '</tr></thead><tbody>';

  teams.forEach(t => {
    const abbr = t.teamAbbrev?.default || t.teamAbbrev || '—';
    const name = t.teamName?.default || t.teamCommonName?.default || '';
    const diff = (t.goalDifferential ?? (t.goalFor - t.goalAgainst)) || 0;
    const diffClass = diff > 0 ? 'diff-pos' : diff < 0 ? 'diff-neg' : 'diff-zero';
    const diffStr = diff > 0 ? `+${diff}` : `${diff}`;
    const ptPctg = typeof t.pointPctg === 'number' ? t.pointPctg.toFixed(3) : (t.pointPctg ?? '—');
    const streak = t.streakCode || '—';
    html += `<tr>
      <td><span class="team-abbr">${abbr}</span> ${name}</td>
      <td>${t.gamesPlayed ?? '—'}</td>
      <td>${t.wins ?? '—'}</td>
      <td>${t.losses ?? '—'}</td>
      <td>${t.otLosses ?? '—'}</td>
      <td class="stat-value">${t.points ?? '—'}</td>
      <td style="font-family:'Source Code Pro',monospace;font-size:0.85rem">${ptPctg}</td>
      <td>${t.goalFor ?? '—'}</td>
      <td>${t.goalAgainst ?? '—'}</td>
      <td class="${diffClass}">${diffStr}</td>
      <td>${t.regulationWins ?? '—'}</td>
      <td style="font-family:'Source Code Pro',monospace;font-size:0.78rem">${streak}</td>
    </tr>`;
  });

  html += '</tbody></table>';
  container.innerHTML = html;
}

function getTeamSortValue(t, col) {
  switch (col) {
    case 'team': return t.teamName?.default || t.teamCommonName?.default || '';
    case 'diff': return (t.goalDifferential ?? (t.goalFor - t.goalAgainst)) || 0;
    case 'pointPctg': return t.pointPctg ?? 0;
    default: return t[col] ?? 0;
  }
}

function sortTeams(col) {
  if (teamsSortState.col === col) {
    teamsSortState.dir = teamsSortState.dir === 'desc' ? 'asc' : 'desc';
  } else {
    teamsSortState.col = col;
    teamsSortState.dir = 'desc';
  }
  renderTeamsTable(currentTeamFilter);
}

function filterTeams(el, filter) {
  document.querySelectorAll('#panel-teams .filter-btn').forEach(b => b.classList.remove('active'));
  el.classList.add('active');
  currentTeamFilter = filter;
  renderTeamsTable(filter);
}

// ─── Render schedule ───
function renderSchedule(data) {
  const container = document.getElementById('scheduleContent');
  try {
    const gameWeek = data.gameWeek || [];
    if (!gameWeek.length) { container.innerHTML = '<div class="error-state">No games scheduled</div>'; return; }

    const todayStr = new Date().toISOString().slice(0, 10);
    let html = '';

    gameWeek.forEach(day => {
      const dateStr = new Date(day.date + 'T12:00:00').toLocaleDateString('en-US', { weekday: 'long', month: 'short', day: 'numeric' });
      const isToday = day.date === todayStr;
      const todayTag = isToday ? '<span class="today-label">Today</span>' : '';
      html += `<div style="margin-bottom:24px">
        <div style="font-family:'Oswald',sans-serif;font-weight:600;font-size:0.85rem;letter-spacing:1.5px;text-transform:uppercase;color:${isToday ? 'var(--accent-ice)' : 'var(--text-secondary)'};margin-bottom:12px;padding-left:2px">${dateStr}${todayTag}</div>
        <div class="schedule-grid">`;

      if (!day.games || !day.games.length) {
        html += '<div class="game-card"><div style="padding:20px;text-align:center;color:var(--text-muted);font-size:0.85rem">No games</div></div>';
      } else {
        day.games.forEach(game => {
          const state = game.gameState;
          const isLive = state === 'LIVE' || state === 'CRIT';
          const isFinal = state === 'OFF' || state === 'FINAL';

          const away = game.awayTeam || {};
          const home = game.homeTeam || {};
          const awayAbbr = away.abbrev || '—';
          const homeAbbr = home.abbrev || '—';

          let statusStr = '';
          if (isLive) {
            const period = game.periodDescriptor?.number || '';
            const clock = game.clock?.timeRemaining || '';
            statusStr = `<span class="live-badge">● LIVE</span> <span>${period ? 'P' + period : ''} ${clock}</span>`;
          } else if (isFinal) {
            const otLabel = game.periodDescriptor?.number > 3
              ? (game.periodDescriptor?.periodType === 'SO' ? ' / SO' : ' / OT')
              : '';
            statusStr = 'Final' + otLabel;
          } else {
            const time = game.startTimeUTC ? new Date(game.startTimeUTC).toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' }) : '';
            statusStr = time;
          }

          const showScore = isLive || isFinal;
          const awayScore = away.score ?? 0;
          const homeScore = home.score ?? 0;

          const awayWon = isFinal && awayScore > homeScore;
          const homeWon = isFinal && homeScore > awayScore;

          html += `<div class="game-card${isLive ? ' live' : ''}">
            <div class="game-meta">
              <span>${game.venue?.default || ''}</span>
              <span>${statusStr}</span>
            </div>
            <div class="game-matchup">
              <div class="game-team${awayWon ? ' game-winner' : ''}">
                <div class="game-team-abbr">${awayAbbr}</div>
                ${away.record ? `<div class="game-team-record">${away.record}</div>` : ''}
              </div>
              <div style="text-align:center">
                ${showScore
                  ? `<div class="game-score">${awayScore} — ${homeScore}</div>`
                  : `<div class="game-vs">VS</div>`
                }
              </div>
              <div class="game-team${homeWon ? ' game-winner' : ''}">
                <div class="game-team-abbr">${homeAbbr}</div>
                ${home.record ? `<div class="game-team-record">${home.record}</div>` : ''}
              </div>
            </div>
          </div>`;
        });
      }
      html += '</div></div>';
    });
    container.innerHTML = html;
  } catch(e) {
    container.innerHTML = '<div class="error-state">Error loading schedule</div>';
  }
}

// ─── Main fetch (parallel) ───
async function refreshAll() {
  const btn = document.getElementById('refreshBtn');
  const statusText = document.getElementById('statusText');
  const statusDot = document.getElementById('statusDot');

  btn.classList.add('loading');
  btn.textContent = 'Loading...';
  statusText.textContent = 'Fetching...';
  statusDot.style.background = 'var(--accent-orange)';
  statusDot.style.boxShadow = '0 0 6px var(--accent-orange)';

  const results = await Promise.allSettled([
    nhlFetch('/skater-stats-leaders/current/2?categories=points&limit=10'),
    nhlFetch('/skater-stats-leaders/current/2?categories=goals&limit=10'),
    nhlFetch('/skater-stats-leaders/current/2?categories=assists&limit=10'),
    nhlFetch('/goalie-stats-leaders/current/2?categories=goalsAgainstAverage&limit=10'),
    nhlFetch('/standings/now'),
    nhlFetch('/schedule/now'),
  ]);

  let errors = 0;

  // Points leaders
  if (results[0].status === 'fulfilled') {
    renderSkaterLeaders(results[0].value, 'pointsLeadersTable', 'points', 'PTS', '');
  } else {
    errors++;
    document.getElementById('pointsLeadersTable').innerHTML = '<div class="error-state">Could not load points leaders</div>';
  }

  // Goals leaders
  if (results[1].status === 'fulfilled') {
    renderSkaterLeaders(results[1].value, 'goalsLeadersTable', 'goals', 'G', 'red');
  } else {
    errors++;
    document.getElementById('goalsLeadersTable').innerHTML = '<div class="error-state">Could not load goals leaders</div>';
  }

  // Assists leaders
  if (results[2].status === 'fulfilled') {
    renderSkaterLeaders(results[2].value, 'assistsLeadersTable', 'assists', 'A', 'green');
  } else {
    errors++;
    document.getElementById('assistsLeadersTable').innerHTML = '<div class="error-state">Could not load assists leaders</div>';
  }

  // Goalies
  if (results[3].status === 'fulfilled') {
    renderGoalies(results[3].value);
  } else {
    errors++;
    document.getElementById('goaliesTable').innerHTML = '<div class="error-state">Could not load goalies</div>';
  }

  // Standings
  if (results[4].status === 'fulfilled') {
    renderStandings(results[4].value, true);
    renderTeams();
  } else {
    errors++;
    document.getElementById('quickStandings').innerHTML = '<div class="error-state">Could not load standings</div>';
    document.getElementById('fullStandings').innerHTML = '<div class="error-state">Could not load standings</div>';
    document.getElementById('teamsContent').innerHTML = '<div class="error-state">Could not load teams</div>';
  }

  // Schedule
  if (results[5].status === 'fulfilled') {
    renderSchedule(results[5].value);
  } else {
    errors++;
    document.getElementById('scheduleContent').innerHTML = '<div class="error-state">Could not load schedule</div>';
  }

  btn.classList.remove('loading');
  btn.textContent = 'Refresh';

  if (errors === 0) {
    statusText.textContent = 'Live';
    statusDot.style.background = 'var(--accent-green)';
    statusDot.style.boxShadow = '0 0 6px var(--accent-green)';
  } else if (errors < 6) {
    statusText.textContent = 'Partial';
    statusDot.style.background = 'var(--accent-orange)';
    statusDot.style.boxShadow = '0 0 6px var(--accent-orange)';
  } else {
    statusText.textContent = 'Offline';
    statusDot.style.background = 'var(--accent-red)';
    statusDot.style.boxShadow = '0 0 6px var(--accent-red)';
  }

  document.getElementById('lastUpdated').textContent = 'Last updated: ' + new Date().toLocaleTimeString();
}

// Auto-refresh every 5 min
setInterval(refreshAll, 300000);

// Initial load
updateSeasonTag();
refreshAll();
</script>
</body>
</html>
